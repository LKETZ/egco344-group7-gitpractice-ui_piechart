<!DOCTYPE html>
<html lang="en">
<head>
    <!--test-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electricity Usage & Users Pie Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        select { padding: 10px; font-size: 15px; border-radius: 6px; border: 1px solid #ddd; min-width: 200px; outline: none; }
        .charts-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .chart-box { background: #fff; padding: 15px; border: 1px solid #eee; border-radius: 8px; height: 500px; }
        h1 { text-align: center; margin-bottom: 30px; color: #2c3e50; }
        h3 { text-align: center; font-size: 1.1em; color: #555; margin-bottom: 15px; }
        @media (max-width: 850px) { .charts-wrapper { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Electricity Distribution Analysis</h1>

    <div class="controls">
        <div class="control-group">
            <label><strong>1. Select Province:</strong></label>
            <select id="provinceSelect"><option>Loading...</option></select>
        </div>
        <div class="control-group">
            <label><strong>2. Select Year:</strong></label>
            <select id="yearSelect"><option>Loading...</option></select>
        </div>
    </div>

    <div class="charts-wrapper">
        <div class="chart-box">
            <h3>Electricity Usage Proportion (kWh)</h3>
            <canvas id="usagePieChart"></canvas>
        </div>
        <div class="chart-box">
            <h3>Electricity Users Proportion (Count)</h3>
            <canvas id="usersPieChart"></canvas>
        </div>
    </div>
</div>

<script>
    let usageData = [];
    let usersData = [];
    let usageChartInstance = null;
    let usersChartInstance = null;

    const cleanData = (data) => Array.isArray(data) ? data : (data.Sheet1 || []);

    async function loadData() {
        try {
            const [usageRes, usersRes] = await Promise.all([
                fetch('electricity_usages_en.json'),
                fetch('electricity_users_en.json')
            ]);
            
            usageData = cleanData(await usageRes.json());
            usersData = cleanData(await usersRes.json());

            populateFilters();
        } catch (error) {
            console.error("Data load error:", error);
            alert("Error: Please check if JSON files exist and run via a web server.");
        }
    }

    function populateFilters() {
        const provinces = [...new Set(usageData.map(item => item.province_name))].sort();
        const years = [...new Set(usageData.map(item => item.year))].sort((a, b) => b - a);

        const pSelect = document.getElementById('provinceSelect');
        const ySelect = document.getElementById('yearSelect');

        pSelect.innerHTML = provinces.map(p => `<option value="${p}">${p}</option>`).join('');
        ySelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

        const updateAll = () => updateCharts(pSelect.value, parseInt(ySelect.value));
        
        pSelect.addEventListener('change', updateAll);
        ySelect.addEventListener('change', updateAll);

        updateAll(); // Initial call
    }

    function createPieChart(canvasId, dataEntry, suffix, chartTitle) {
        if (!dataEntry) return;

        const categories = Object.keys(dataEntry).filter(k => k.endsWith(suffix));
        const labels = categories.map(c => c.replace(suffix, '').replace(/_/g, ' ').toUpperCase());
        const values = categories.map(c => dataEntry[c]);

        // Filter out zero values to make the pie chart cleaner
        const filtered = labels.map((l, i) => ({ label: l, value: values[i] })).filter(item => item.value > 0);

        const ctx = document.getElementById(canvasId).getContext('2d');
        
        if (canvasId === 'usagePieChart' && usageChartInstance) usageChartInstance.destroy();
        if (canvasId === 'usersPieChart' && usersChartInstance) usersChartInstance.destroy();

        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
            '#FF9F40', '#C9CBCF', '#45ba4b', '#8e44ad', '#2c3e50'
        ];

        const chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: filtered.map(f => f.label),
                datasets: [{
                    data: filtered.map(f => f.value),
                    backgroundColor: colors,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let val = context.raw;
                                let perc = ((val / total) * 100).toFixed(2) + "%";
                                return ` ${context.label}: ${val.toLocaleString()} (${perc})`;
                            }
                        }
                    }
                }
            }
        });

        if (canvasId === 'usagePieChart') usageChartInstance = chart;
        else usersChartInstance = chart;
    }

    function updateCharts(province, year) {
        const selectedUsage = usageData.find(d => d.province_name === province && d.year === year);
        const selectedUsers = usersData.find(d => d.province_name === province && d.year === year);

        createPieChart('usagePieChart', selectedUsage, '_kwh', 'Usage');
        createPieChart('usersPieChart', selectedUsers, '_count', 'Users');
    }

    loadData();
</script>
</body>
</html>