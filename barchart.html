<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electricity Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Controls */
        .controls {
            background: white; padding: 25px; border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px;
            display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;
        }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; min-width: 200px; }
        
        /* Charts */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #555; margin-bottom: 15px; font-size: 1.1rem; }
        .chart-box { position: relative; height: 350px; }
        
        /* Loading Overlay */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
        .error-msg { color: red; max-width: 600px; text-align: center; margin-top: 20px; display: none; }

        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loading">
        <h2>Loading Data Files...</h2>
        <p>Please ensure you are running this via a Local Server (e.g., Live Server).</p>
        <div id="errorText" class="error-msg"></div>
    </div>

    <div class="container">
        <h1 style="text-align:center; margin-bottom: 20px;">âš¡ Provincial Electricity Dashboard</h1>

        <div class="controls">
            <div class="control-group">
                <label for="provinceSelect">Select Province:</label>
                <select id="provinceSelect"></select>
            </div>
            <div class="control-group">
                <label for="yearSelect">Select Year:</label>
                <select id="yearSelect">
                    <option value="ALL" style="font-weight:bold;">All Years (Compare)</option>
                </select>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Electricity Usage (kWh)</h2>
                <div class="chart-box"><canvas id="usageChart"></canvas></div>
            </div>
            <div class="card">
                <h2>Number of Users</h2>
                <div class="chart-box"><canvas id="usersChart"></canvas></div>
            </div>
        </div>
    </div>

<script>
    // --- Configuration ---
    // Define the column names used in your JSON files here.
    const USAGE_KEYS = {
        residential: 'residential_kwh',
        small_biz: 'small_business_kwh',
        medium_biz: 'medium_business_kwh',
        large_biz: 'large_business_kwh',
        gov: 'government_state_enterprise_kwh' // Add others if needed
    };

    // Assuming Users JSON uses similar keys (e.g. residential_users). 
    // Update these if your JSON keys are different.
    const USER_KEYS = {
        residential: 'residential_users',
        small_biz: 'small_business_users',
        medium_biz: 'medium_business_users',
        large_biz: 'large_business_users',
        gov: 'government_state_enterprise_users'
    };

    const LABELS = ['Residential', 'Small Biz', 'Medium Biz', 'Large Biz', 'Gov/State'];
    
    // Global Data Storage
    let usageData = [];
    let usersData = [];
    
    // Chart Instances
    let chartUsage = null;
    let chartUsers = null;

    // --- 1. Fetch Data ---
    async function loadData() {
        try {
            // Load both files in parallel
            const [usageRes, usersRes] = await Promise.all([
                fetch('electricity_usages_en.json'),
                fetch('electricity_users_en.json')
            ]);

            if (!usageRes.ok || !usersRes.ok) throw new Error("File not found (404)");

            usageData = await usageRes.json();
            usersData = await usersRes.json();

            // Hide loading screen
            document.getElementById('loading').style.display = 'none';
            
            // Initialize App
            initDashboard();

        } catch (error) {
            console.error(error);
            const errDiv = document.getElementById('errorText');
            errDiv.style.display = 'block';
            errDiv.innerHTML = `
                <strong>Error loading data:</strong> ${error.message}<br><br>
                <em>Note: If you opened this file directly, browsers block reading local JSON files.<br>
                Please use "Live Server" in VS Code or "python -m http.server".</em>
            `;
        }
    }

    // --- 2. Initialize Controls ---
    function initDashboard() {
        // Extract Unique Provinces (sorted)
        const provinces = [...new Set(usageData.map(d => d.province_name))].sort();
        
        // Extract Unique Years (sorted newest first)
        const years = [...new Set(usageData.map(d => d.year))].sort((a,b) => b - a);

        // Populate Province Dropdown
        const provinceSelect = document.getElementById('provinceSelect');
        provinces.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.textContent = p;
            provinceSelect.appendChild(opt);
        });

        // Populate Year Dropdown
        const yearSelect = document.getElementById('yearSelect');
        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y; opt.textContent = y;
            yearSelect.appendChild(opt);
        });

        // Add Listeners
        provinceSelect.addEventListener('change', updateCharts);
        yearSelect.addEventListener('change', updateCharts);

        // Initial Render
        updateCharts();
    }

    // --- 3. Update Charts ---
    function updateCharts() {
        const selectedProvince = document.getElementById('provinceSelect').value;
        const selectedYear = document.getElementById('yearSelect').value;

        // Filter Logic
        let yearsToShow = [];
        if (selectedYear === 'ALL') {
            yearsToShow = [...new Set(usageData.map(d => d.year))].sort((a,b) => a - b);
        } else {
            yearsToShow = [parseInt(selectedYear)];
        }

        // Prepare Datasets
        const datasetsUsage = [];
        const datasetsUsers = [];

        const colors = ['#3498db', '#e67e22', '#2ecc71', '#9b59b6', '#f1c40f']; // Colors for years

        yearsToShow.forEach((year, index) => {
            const color = colors[index % colors.length];

            // 1. Get Usage Data Row
            const uRow = usageData.find(d => d.year === year && d.province_name === selectedProvince);
            if (uRow) {
                const data = [
                    uRow[USAGE_KEYS.residential] || 0,
                    uRow[USAGE_KEYS.small_biz] || 0,
                    uRow[USAGE_KEYS.medium_biz] || 0,
                    uRow[USAGE_KEYS.large_biz] || 0,
                    uRow[USAGE_KEYS.gov] || 0
                ];
                datasetsUsage.push({
                    label: `Year ${year}`,
                    data: data,
                    backgroundColor: color,
                    borderColor: 'rgba(0,0,0,0.1)',
                    borderWidth: 1
                });
            }

            // 2. Get Users Data Row
            const userRow = usersData.find(d => d.year === year && d.province_name === selectedProvince);
            if (userRow) {
                const data = [
                    userRow[USER_KEYS.residential] || 0,
                    userRow[USER_KEYS.small_biz] || 0,
                    userRow[USER_KEYS.medium_biz] || 0,
                    userRow[USER_KEYS.large_biz] || 0,
                    userRow[USER_KEYS.gov] || 0
                ];
                datasetsUsers.push({
                    label: `Year ${year}`,
                    data: data,
                    backgroundColor: color,
                    borderColor: 'rgba(0,0,0,0.1)',
                    borderWidth: 1
                });
            }
        });

        // Render
        renderChart('usageChart', chartUsage, datasetsUsage, 'Electricity Usage (kWh)', c => chartUsage = c);
        renderChart('usersChart', chartUsers, datasetsUsers, 'Number of Users', c => chartUsers = c);
    }

    // Generic Render Function
    function renderChart(canvasId, chartInstance, datasets, title, setInstance) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const newChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: LABELS,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: title } }
                }
            }
        });
        setInstance(newChart);
    }

    // Start
    loadData();

</script>
</body>
</html>